name: Jayce Land - CI/CD Pipeline

on:
  push:
    branches: [main]

env:
  PROJECT_PATH: /home/jayce/jayceland
  REPO_URL: git@github.com:JayceBordelon/jayceland.git

jobs:
  sync:
    name: Sync Repository
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Clone fresh repository
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            
            # Nuke and reclone repo
            rm -rf ${{ env.PROJECT_PATH }}
            git clone ${{ env.REPO_URL }} ${{ env.PROJECT_PATH }}
            
            echo "✓ Repository cloned successfully"

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: sync
    steps:
      - uses: actions/checkout@v4

      - name: Run linter
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            cd ${{ env.PROJECT_PATH }}

            cd jaycebordelon.com
            npm install
            npm run lint
            cd ..

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Build application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            cd ${{ env.PROJECT_PATH }}

            rm -rf jaycebordelon.com/.next jaycebordelon.com/node_modules/.cache

            COMMIT_SHA=$(git rev-parse HEAD)
            SHORT_SHA=$(git rev-parse --short HEAD)

            # Just build the new image - don't touch traefik or running containers
            docker compose build --no-cache jaycebordelon-com
            docker tag jaycebordelon.com:latest "jaycebordelon.com:${SHORT_SHA}"

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: build
    outputs:
      commit_sha: ${{ steps.get_info.outputs.commit_sha }}
      short_sha: ${{ steps.get_info.outputs.short_sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Get commit info
        id: get_info
        run: |
          echo "commit_sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "short_sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Deploy to production
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            cd ${{ env.PROJECT_PATH }}

            # Zero-downtime rolling deployment of your app
            docker rollout jaycebordelon-com --timeout 120 --wait-after-healthy 30

            # Cleanup old images
            docker image prune -f
            docker images "jaycebordelon.com" --format "{{.ID}} {{.CreatedAt}}" | sort -rk 2 | tail -n +4 | awk '{print $1}' | xargs -r docker rmi -f || true
            # System Cleanup
            docker system prune -af --volumes

  healthcheck:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy
    outputs:
      status: ${{ steps.health.outputs.status }}
      results: ${{ steps.health.outputs.results }}
    steps:
      - name: Verify endpoints
        id: health
        run: |
          set -e

          ENDPOINTS=(
            "https://jaycebordelon.com"
            "https://www.jaycebordelon.com"
          )

          FAILED=0
          RESULTS=""

          for endpoint in "${ENDPOINTS[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$endpoint" || echo "000")
            
            if [[ "$STATUS" =~ ^2[0-9]{2}$ ]]; then
              RESULTS="${RESULTS}✓ $endpoint ($STATUS)\n"
            else
              RESULTS="${RESULTS}✗ $endpoint ($STATUS)\n"
              FAILED=1
            fi
          done

          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ $FAILED -eq 1 ]; then
            echo "status=FAILED" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "status=PASSED" >> $GITHUB_OUTPUT
          fi

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [deploy, healthcheck]
    if: always()
    steps:
      - name: Send deployment summary email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: bordelonjayce@gmail.com
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[${{ needs.healthcheck.outputs.status }}] Jayce Land Deployment - ${{ needs.deploy.outputs.short_sha }}"
          to: bordelonjayce@gmail.com
          from: Jayce Land CI/CD <bordelonjayce@gmail.com>
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { 
                  font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
                  line-height: 1.6; 
                  color: #000000;
                  background-color: #f9f9fa;
                  margin: 0;
                  padding: 0;
                }
                .container { 
                  max-width: 600px; 
                  margin: 40px auto; 
                  background: #ffffff;
                  border: 1px solid #e0e0e0;
                  border-radius: 8px;
                  overflow: hidden;
                }
                .header { 
                  background: #34a85a;
                  color: #ffffff;
                  padding: 32px 24px;
                  text-align: center;
                }
                .header.failed { 
                  background: #ef4444;
                }
                .header h1 {
                  margin: 0;
                  font-size: 24px;
                  font-weight: 700;
                  letter-spacing: -0.02em;
                }
                .content { 
                  padding: 32px 24px;
                }
                .section { 
                  margin: 24px 0;
                  padding-bottom: 24px;
                  border-bottom: 1px solid #e0e0e0;
                }
                .section:last-child {
                  border-bottom: none;
                  padding-bottom: 0;
                }
                .section h3 { 
                  margin: 0 0 16px 0;
                  color: #000000;
                  font-size: 16px;
                  font-weight: 600;
                  letter-spacing: -0.01em;
                }
                .info-grid { 
                  display: grid;
                  grid-template-columns: 140px 1fr;
                  gap: 12px;
                  font-size: 14px;
                }
                .info-label { 
                  font-weight: 600;
                  color: #050505;
                }
                .info-value {
                  color: #000000;
                  word-break: break-all;
                }
                .health-results { 
                  background: #fafafa;
                  padding: 16px;
                  border-radius: 6px;
                  border: 1px solid #e0e0e0;
                  font-family: 'JetBrains Mono', 'Courier New', monospace;
                  font-size: 13px;
                  line-height: 1.8;
                }
                .footer { 
                  text-align: center;
                  padding: 24px;
                  color: #c9c9c9;
                  font-size: 12px;
                  background: #fafafa;
                  border-top: 1px solid #e0e0e0;
                }
                .status-badge { 
                  display: inline-block;
                  padding: 6px 16px;
                  border-radius: 6px;
                  font-weight: 600;
                  font-size: 14px;
                  margin-top: 8px;
                }
                .status-passed { 
                  background: #7ed957;
                  color: #000000;
                }
                .status-failed { 
                  background: #ef4444;
                  color: #ffffff;
                }
                a {
                  color: #34a85a;
                  text-decoration: none;
                }
                a:hover {
                  text-decoration: underline;
                }
                pre {
                  margin: 0;
                  white-space: pre-wrap;
                  word-wrap: break-word;
                }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header ${{ needs.healthcheck.outputs.status == 'FAILED' && 'failed' || '' }}">
                  <h1>Jayce Land Deployment</h1>
                  <span class="status-badge status-${{ needs.healthcheck.outputs.status == 'FAILED' && 'failed' || 'passed' }}">
                    ${{ needs.healthcheck.outputs.status }}
                  </span>
                </div>
                
                <div class="content">
                  <div class="section">
                    <h3>Deployment Details</h3>
                    <div class="info-grid">
                      <span class="info-label">Repository</span>
                      <span class="info-value">${{ github.repository }}</span>
                      
                      <span class="info-label">Branch</span>
                      <span class="info-value">${{ github.ref_name }}</span>
                      
                      <span class="info-label">Commit</span>
                      <span class="info-value">${{ needs.deploy.outputs.commit_sha }}</span>
                      
                      <span class="info-label">Version</span>
                      <span class="info-value">jayce.com:${{ needs.deploy.outputs.short_sha }}</span>
                      
                      <span class="info-label">Triggered by</span>
                      <span class="info-value">${{ github.actor }}</span>
                      
                      <span class="info-label">Workflow Run</span>
                      <span class="info-value"><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">#${{ github.run_number }}</a></span>
                    </div>
                  </div>
                  
                  <div class="section">
                    <h3>Health Check Results</h3>
                    <div class="health-results">
                      <pre>${{ needs.healthcheck.outputs.results }}</pre>
                    </div>
                  </div>
                  
                  <div class="section">
                    <h3>Quick Links</h3>
                    <div style="line-height: 2;">
                      <a href="https://jaycebordelon.com">https://jaycebordelon.com</a><br>
                      <a href="https://www.jaycebordelon.com">https://www.jaycebordelon.com</a><br>
                      <a href="${{ github.server_url }}/${{ github.repository }}/commit/${{ needs.deploy.outputs.commit_sha }}">View Commit</a>
                    </div>
                  </div>
                </div>
                
                <div class="footer">
                  <p>Automated deployment notification from Jayce Land CI/CD</p>
                </div>
              </div>
            </body>
            </html>