name: Jayce Land - CI/CD Pipeline

on:
  push:
    branches: [main]

env:
  PROJECT_PATH: /home/jayce/career

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run linter
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            cd ${{ env.PROJECT_PATH }}

            git pull origin main

            cd jayceb.com
            npm install
            npm run lint
            cd ..

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Build application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            cd ${{ env.PROJECT_PATH }}
            git pull origin main

            rm -rf jayceb.com/.next jayceb.com/node_modules/.cache

            docker compose up -d traefik

            COMMIT_SHA=$(git rev-parse HEAD)
            SHORT_SHA=$(git rev-parse --short HEAD)

            docker compose build --no-cache jayceb-com
            docker tag jayce.com:latest "jayce.com:${SHORT_SHA}"

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: build
    outputs:
      commit_sha: ${{ steps.get_info.outputs.commit_sha }}
      short_sha: ${{ steps.get_info.outputs.short_sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Get commit info
        id: get_info
        run: |
          echo "commit_sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "short_sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Deploy to production
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            cd ${{ env.PROJECT_PATH }}

            docker rollout jayceb-com --timeout 120 --wait-after-healthy 30

            docker image prune -f
            docker images "jayce.com" --format "{{.ID}} {{.CreatedAt}}" | sort -rk 2 | tail -n +4 | awk '{print $1}' | xargs -r docker rmi -f || true

  healthcheck:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy
    outputs:
      status: ${{ steps.health.outputs.status }}
      results: ${{ steps.health.outputs.results }}
    steps:
      - name: Verify endpoints
        id: health
        run: |
          set -e

          ENDPOINTS=(
            "https://jayceb.com"
            "https://www.jayceb.com"
          )

          FAILED=0
          RESULTS=""

          for endpoint in "${ENDPOINTS[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$endpoint" || echo "000")
            
            if [[ "$STATUS" =~ ^2[0-9]{2}$ ]]; then
              RESULTS="${RESULTS}‚úì $endpoint ($STATUS)\n"
            else
              RESULTS="${RESULTS}‚úó $endpoint ($STATUS)\n"
              FAILED=1
            fi
          done

          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ $FAILED -eq 1 ]; then
            echo "status=FAILED" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "status=PASSED" >> $GITHUB_OUTPUT
          fi

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [deploy, healthcheck]
    if: always()
    steps:
      - name: Send deployment summary email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: bordelonjayce@gmail.com
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[${{ needs.healthcheck.outputs.status }}] Jayce Land Deployment - ${{ needs.deploy.outputs.short_sha }}"
          to: bordelonjayce@gmail.com
          from: Jayce Land CI/CD <bordelonjayce@gmail.com>
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: #4CAF50; color: white; padding: 20px; text-align: center; border-radius: 5px 5px 0 0; }
                .header.failed { background: #f44336; }
                .content { background: #f9f9f9; padding: 20px; border: 1px solid #ddd; }
                .section { margin: 20px 0; }
                .section h3 { margin-top: 0; color: #555; border-bottom: 2px solid #4CAF50; padding-bottom: 5px; }
                .info-grid { display: grid; grid-template-columns: 150px 1fr; gap: 10px; }
                .info-label { font-weight: bold; color: #666; }
                .health-results { background: white; padding: 15px; border-radius: 5px; font-family: monospace; }
                .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }
                .status-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-weight: bold; }
                .status-passed { background: #4CAF50; color: white; }
                .status-failed { background: #f44336; color: white; }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header ${{ needs.healthcheck.outputs.status == 'FAILED' && 'failed' || '' }}">
                  <h1>üöÄ Jayce Land Deployment</h1>
                  <span class="status-badge status-${{ needs.healthcheck.outputs.status == 'FAILED' && 'failed' || 'passed' }}">
                    ${{ needs.healthcheck.outputs.status }}
                  </span>
                </div>
                
                <div class="content">
                  <div class="section">
                    <h3>üìã Deployment Details</h3>
                    <div class="info-grid">
                      <span class="info-label">Repository:</span>
                      <span>${{ github.repository }}</span>
                      
                      <span class="info-label">Branch:</span>
                      <span>${{ github.ref_name }}</span>
                      
                      <span class="info-label">Commit:</span>
                      <span>${{ needs.deploy.outputs.commit_sha }}</span>
                      
                      <span class="info-label">Version:</span>
                      <span>jayce.com:${{ needs.deploy.outputs.short_sha }}</span>
                      
                      <span class="info-label">Triggered by:</span>
                      <span>${{ github.actor }}</span>
                      
                      <span class="info-label">Workflow:</span>
                      <span><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">#${{ github.run_number }}</a></span>
                    </div>
                  </div>
                  
                  <div class="section">
                    <h3>üè• Health Check Results</h3>
                    <div class="health-results">
                      <pre>${{ needs.healthcheck.outputs.results }}</pre>
                    </div>
                  </div>
                  
                  <div class="section">
                    <h3>üîó Quick Links</h3>
                    <p>
                      ‚Ä¢ <a href="https://jayceb.com">https://jayceb.com</a><br>
                      ‚Ä¢ <a href="https://www.jayceb.com">https://www.jayceb.com</a><br>
                      ‚Ä¢ <a href="${{ github.server_url }}/${{ github.repository }}/commit/${{ needs.deploy.outputs.commit_sha }}">View Commit</a>
                    </p>
                  </div>
                </div>
                
                <div class="footer">
                  <p>Automated deployment notification from Jayce Land CI/CD</p>
                </div>
              </div>
            </body>
            </html>
