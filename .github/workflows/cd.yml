name: Jayce Land - CI/CD Pipeline

on:
  push:
    branches: [main]

env:
  PROJECT_PATH: /home/jayce/career

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run linter
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            cd ${{ env.PROJECT_PATH }}

            git pull origin main

            echo "=== Linting jayceb.com ==="
            cd jayceb.com
            npm install
            npm run lint
            cd ..

            echo "‚úì Project linted successfully"

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Build application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd ${{ env.PROJECT_PATH }}
            git pull origin main

            # Clean cache
            rm -rf jayceb.com/.next jayceb.com/node_modules/.cache

            # Ensure Traefik is running
            docker compose up -d traefik

            COMMIT_SHA=$(git rev-parse HEAD)
            SHORT_SHA=$(git rev-parse --short HEAD)

            echo "Building jayceb-com:${SHORT_SHA}..."
            docker compose build --no-cache jayceb-com
            docker tag jayce.com:latest "jayce.com:${SHORT_SHA}"

            echo "‚úì Build complete: ${SHORT_SHA}"

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to production
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd ${{ env.PROJECT_PATH }}

            COMMIT_SHA=$(git rev-parse HEAD)
            SHORT_SHA=$(git rev-parse --short HEAD)

            echo "=== Deploying jayceb-com:${SHORT_SHA} ==="
            docker rollout jayceb-com --timeout 120 --wait-after-healthy 30

            echo "=== Cleaning up ==="
            docker image prune -f
            docker images "jayce.com" --format "{{.ID}} {{.CreatedAt}}" | sort -rk 2 | tail -n +4 | awk '{print $1}' | xargs -r docker rmi -f || true

            echo ""
            echo "‚úì DEPLOYMENT COMPLETE: ${SHORT_SHA}"
            echo "  ‚Ä¢ jayceb.com: https://jayceb.com"

  healthcheck:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Verify endpoints
        run: |
          echo "üè• Running health checks..."

          ENDPOINTS=(
            "https://jayceb.com"
            "https://www.jayceb.com"
          )

          FAILED=0

          for endpoint in "${ENDPOINTS[@]}"; do
            echo "Checking: $endpoint"
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$endpoint" || echo "000")
            
            if [[ "$STATUS" =~ ^2[0-9]{2}$ ]]; then
              echo "  ‚úì $endpoint - $STATUS OK"
            else
              echo "  ‚úó $endpoint - $STATUS FAILED"
              FAILED=1
            fi
          done

          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "‚ùå Health check failed!"
            exit 1
          fi

          echo ""
          echo "‚úÖ All endpoints healthy!"
