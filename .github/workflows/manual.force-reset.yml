name: Server Hard Reset

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "RESET" to confirm'
        required: true
        type: string

jobs:
  hard-reset:
    name: Hard Reset
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "RESET" ]; then
            echo "Confirmation failed. Type RESET to proceed."
            exit 1
          fi

      - uses: actions/checkout@v4

      - name: Execute reset
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            cd /home/jayce/jayceland

            docker compose down
            docker system prune -af --volumes

            git restore .
            git clean -fd
            git fetch --all
            git reset --hard origin/main

            docker compose build --no-cache
            docker compose up -d

      - name: Wait for startup
        run: sleep 10

      - name: Verify deployment
        run: |
          ENDPOINTS=(
            "https://www.jaycebordelon.com"
            "https://jaycebordelon.com"
          )

          FAILED=0

          for endpoint in "${ENDPOINTS[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$endpoint" || echo "000")

            if [[ "$STATUS" =~ ^2[0-9]{2}$ ]]; then
              echo "OK: $endpoint ($STATUS)"
            else
              echo "FAIL: $endpoint ($STATUS)"
              FAILED=1
            fi
          done

          if [ $FAILED -eq 1 ]; then
            echo "Health check failed"
            exit 1
          fi

      - name: Send notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: bordelonjayce@gmail.com
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[HARD RESET] JayceLand - ${{ job.status == 'success' && 'SUCCESS' || 'FAILED' }}"
          to: jayce@occupai.us
          from: JayceLand CI/CD <automation@gmail.com>
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body {
                  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                  background-color: #121212;
                  margin: 0;
                  padding: 40px 20px;
                }
                .container {
                  max-width: 600px;
                  margin: 0 auto;
                  background-color: #171717;
                  border-radius: 12px;
                  overflow: hidden;
                  border: 2px solid #ff1e00;
                }
                .header {
                  background: linear-gradient(135deg, #ff1e00 0%, #dc2626 100%);
                  padding: 40px;
                  text-align: center;
                }
                .header h1 {
                  color: #ffffff;
                  font-size: 24px;
                  font-weight: 700;
                  margin: 0 0 8px 0;
                }
                .header p {
                  color: rgba(255, 255, 255, 0.85);
                  font-size: 14px;
                  margin: 0;
                }
                .status-badge {
                  display: inline-block;
                  padding: 6px 16px;
                  border-radius: 4px;
                  font-weight: 700;
                  font-size: 14px;
                  margin-top: 16px;
                }
                .status-success {
                  background: #2dd4bf;
                  color: #000000;
                }
                .status-failed {
                  background: #ff1e00;
                  color: #ffffff;
                }
                .content {
                  padding: 32px;
                }
                .warning-box {
                  background-color: #2a1515;
                  border: 1px solid #ff1e00;
                  border-radius: 8px;
                  padding: 16px;
                  color: #ffb3b3;
                  font-size: 13px;
                  margin-bottom: 24px;
                }
                .info-box {
                  background-color: #242424;
                  border-radius: 8px;
                  padding: 20px;
                  border: 1px solid #292929;
                }
                .info-row {
                  display: flex;
                  justify-content: space-between;
                  padding: 8px 0;
                  font-size: 13px;
                  border-bottom: 1px solid #333;
                }
                .info-row:last-child {
                  border-bottom: none;
                }
                .info-label {
                  color: #898989;
                }
                .info-value {
                  color: #e2e8f0;
                  font-weight: 600;
                }
                a {
                  color: #ff1e00;
                  text-decoration: none;
                }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">
                  <h1>Server Hard Reset</h1>
                  <p>Full Docker system wipe and rebuild</p>
                  <span class="status-badge status-${{ job.status == 'success' && 'success' || 'failed' }}">
                    ${{ job.status == 'success' && 'SUCCESS' || 'FAILED' }}
                  </span>
                </div>

                <div class="content">
                  <div class="warning-box">
                    <strong>Destructive action performed:</strong> All Docker containers, images, volumes, and networks deleted. System rebuilt from scratch.
                  </div>

                  <div class="info-box">
                    <div class="info-row">
                      <span class="info-label">Triggered by</span>
                      <span class="info-value">${{ github.actor }}</span>
                    </div>
                    <div class="info-row">
                      <span class="info-label">Repository</span>
                      <span class="info-value">${{ github.repository }}</span>
                    </div>
                    <div class="info-row">
                      <span class="info-label">Branch</span>
                      <span class="info-value">${{ github.ref_name }}</span>
                    </div>
                    <div class="info-row">
                      <span class="info-label">Workflow</span>
                      <span class="info-value"><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">#${{ github.run_number }}</a></span>
                    </div>
                  </div>
                </div>
              </div>
            </body>
            </html>
