name: Jayce Land - CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: production-deployment
  cancel-in-progress: false

env:
  PROJECT_PATH: /home/jayce/jayceland
  REPO_URL: git@github.com:JayceBordelon/jayceland.git

jobs:
  sync:
    name: Sync
    uses: ./.github/workflows/sync.yml
    secrets: inherit
    with:
      project_path: /home/jayce/jayceland
      repo_url: git@github.com:JayceBordelon/jayceland.git

  lint:
    name: Lint
    needs: sync
    if: success()
    uses: ./.github/workflows/lint.yml
    secrets: inherit
    with:
      project_path: /home/jayce/jayceland

  build:
    name: Build
    needs: lint
    if: success()
    uses: ./.github/workflows/build.yml
    secrets: inherit
    with:
      project_path: /home/jayce/jayceland

  deploy:
    name: Deploy
    needs: build
    if: success()
    uses: ./.github/workflows/deploy.yml
    secrets: inherit
    with:
      project_path: /home/jayce/jayceland

  healthcheck:
    name: Health Check
    needs: deploy
    if: success()
    uses: ./.github/workflows/healthcheck.yml
    secrets: inherit

  notify:
    name: Notify
    needs: [sync, lint, build, deploy, healthcheck]
    if: always()
    uses: ./.github/workflows/notify.yml
    secrets: inherit
    with:
      sync_status: ${{ needs.sync.result == 'success' && needs.sync.outputs.status || (needs.sync.result == 'skipped' && '○ Not Run' || '✗ FAILED') }}
      sync_error: ${{ needs.sync.outputs.error || '' }}
      lint_status: ${{ needs.lint.result == 'success' && needs.lint.outputs.status || (needs.lint.result == 'skipped' && '○ Not Run' || '✗ FAILED') }}
      lint_error: ${{ needs.lint.outputs.error || '' }}
      build_status: ${{ needs.build.result == 'success' && needs.build.outputs.status || (needs.build.result == 'skipped' && '○ Not Run' || '✗ FAILED') }}
      build_error: ${{ needs.build.outputs.error || '' }}
      deploy_status: ${{ needs.deploy.result == 'success' && needs.deploy.outputs.status || (needs.deploy.result == 'skipped' && '○ Not Run' || '✗ FAILED') }}
      deploy_error: ${{ needs.deploy.outputs.error || '' }}
      deploy_commit_sha: ${{ needs.deploy.outputs.commit_sha || github.sha }}
      deploy_short_sha: ${{ needs.deploy.outputs.short_sha || 'unknown' }}
      deploy_commit_message: ${{ needs.deploy.outputs.commit_message || 'No message' }}
      deploy_commit_author: ${{ needs.deploy.outputs.commit_author || github.actor }}
      deploy_commit_timestamp: ${{ needs.deploy.outputs.commit_timestamp || 'Unknown' }}
      healthcheck_status: ${{ needs.healthcheck.result == 'success' && needs.healthcheck.outputs.status || (needs.healthcheck.result == 'skipped' && '○ Not Run' || '✗ FAILED') }}
      healthcheck_error: ${{ needs.healthcheck.outputs.error || '' }}
      healthcheck_results: ${{ needs.healthcheck.outputs.results || 'No results' }}
